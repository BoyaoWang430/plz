<script type="text/x-template" id="log-viewer-template">
    <el-row>
        <el-col :span="20">
            <el-table
                    :data="tableData"
                    row-key="timestamp"
                    stripe
                    border
                    style="width: 100%;">
                <el-table-column label="timestamp" :formatter="formatTimestamp" />
                <el-table-column v-for="item in userDefinedColumns" :prop="item" :label="item" resizable />
                <el-table-column label="event" prop="event" />
                <el-table-column label="details" min-width="400">
                    <template slot-scope="scope">
                        <table>
                            <tr v-for="(propValue, propKey) in scope.row" v-if="shouldShowProp(propKey)">
                                <td>{{ propKey }}</td><td>{{ propValue }}</td>
                            </tr>
                        </table>
                    </template>
                </el-table-column>
            </el-table>
        </el-col>
        <el-col :span="4" style="pdding-right: 1em;">
            <ul style="position:fixed; _position:absolute; top:8px; z-index:999; list-style-type: none;">
                <li @click="scrollToTop" style="cursor: pointer;">
                    <i class="el-icon-upload2"></i> Scroll to Top
                </li>
                <li><h3>Filters</h3>
                    <ul>
                        <li v-for="propKey in filterablePropKeys">{{ propKey }}</li>
                    </ul>
                </li>
                <li><h3>Excluded Properties</h3>
                    <div>
                        <el-tag
                                :key="tag"
                                v-for="tag in excludedPropKeys"
                                closable
                                :disable-transitions="false"
                                @close="handleClose(tag)">
                            {{tag}}
                        </el-tag>
                        <el-input
                                class="input-new-tag"
                                v-if="inputVisible"
                                v-model="inputValue"
                                ref="saveTagInput"
                                size="small"
                                @keyup.enter.native="handleInputConfirm"
                                @blur="handleInputConfirm">
                        </el-input>
                        <el-button v-else class="button-new-tag" size="small" @click="showInput">+ New Tag</el-button>
                    </div>
                </li>
            </ul>
        </el-col>
    </el-row>
</script>
<script>
    Vue.component('log-viewer', {
        template: '#log-viewer-template',
        data: function () {
            return {
                events: [],
                userDefinedColumns: [],
                excludedPropKeys: ['response'],
                filters: {},
                inputVisible: false,
                inputValue: '',
            }
        },
        methods: {
            formatTimestamp: function(row, column, cellValue) {
                var d = new Date(row.timestamp / 1000000);
                return d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds() + '.' + d.getMilliseconds();
            },
            scrollToTop: function() {
                window.scrollTo(0, 0);
            },
            handleClose: function(tag) {
                this.excludedPropKeys.splice(this.excludedPropKeys.indexOf(tag), 1);
            },

            showInput: function() {
                this.inputVisible = true;
                this.$nextTick = function() {
                    this.$refs.saveTagInput.$refs.input.focus();
                };
            },
            handleInputConfirm: function() {
                var inputValue = this.inputValue;
                if (inputValue) {
                    this.excludedPropKeys.push(inputValue);
                }
                this.inputVisible = false;
                this.inputValue = '';
            },
            shouldShowProp: function(propKey) {
                if (this.excludedPropKeys.indexOf(propKey) !== -1) {
                    return false;
                }
                return propKey !== 'lineNumber' && propKey !== 'level' && propKey !== 'event' && propKey !== 'timestamp'
            }
        },
        computed: {
            tableData: function() {
                if (this.events.length < 1000) {
                    return this.events;
                }
                return this.events.slice(0, 1000);
            },
            filterablePropKeys: function() {
                var propKeys = [];
                for (var propKey in this.filters) {
                    if (this.filters[propKey].length > 0) {
                        propKeys.push(propKey);
                        continue;
                    }
                    if (this.excludedPropKeys.indexOf(propKey) !== -1) {
                        continue;
                    }
                    if (propKey !== 'lineNumber' && propKey !== 'level' && propKey !== 'event' && propKey !== 'timestamp') {
                        propKeys.push(propKey);
                    }
                }
                return propKeys;
            }
        },
        created: function() {
            var me = this;
            (function(){
                axios.get('/more-events?ts=' + Date.now())
                    .then(function (resp) {
                        for (var i in resp.data) {
                            var event = resp.data[i];
                            for (var prop in event) {
                                if (!(prop in me.filters)) {
                                    Vue.set(me.filters, prop, []);
                                }
                            }
                        }
                        me.events = resp.data.reverse().concat(me.events);
                    });
                setTimeout(arguments.callee, 1000);
            })();
        }
    })
</script>