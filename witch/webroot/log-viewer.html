<script type="text/x-template" id="log-viewer-template">
    <el-row>
        <el-col :span="20">
            <el-table
                    :data="tableData"
                    row-key="timestamp"
                    border
                    style="width: 100%;">
                <el-table-column label="timestamp" :formatter="formatTimestamp" width="140" />
                <el-table-column v-for="item in userDefinedColumns" :prop="item" :key="item" :label="item" resizable />
                <el-table-column label="event" prop="event" />
            </el-table>
        </el-col>
        <el-col :span="4" style="pdding-right: 1em; padding-left: 1em;">
            <filters :propValues="propValues" :filters.sync="filters"></filters>
        </el-col>
    </el-row>
</script>
<script>
    Vue.component('log-viewer', {
        template: '#log-viewer-template',
        data: function () {
            return {
                filters: {'cacheKey': '__filtered_by_0'},
                events: [],
                userDefinedColumns: [],
                excludedPropKeys: ['response'],
                propValues: {},
                propViewModes: {
                    event: 'column',
                    timestamp: 'column',
                    level: 'hidden',
                    lineNumber: 'hidden'
                },
            }
        },
        methods: {
            formatTimestamp: function(row, column, cellValue) {
                var d = new Date(row.timestamp / 1000000);
                return d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds() + '.' + d.getMilliseconds();
            },
            isInlineProp: function(propKey) {
                return (this.propViewModes[propKey] || 'inline') == 'inline';
            },
            isFiltered: function(event, cacheKey) {
                var cacheValue = event[cacheKey];
                if (cacheValue !== undefined) {
                    return cacheValue;
                }
                for (var propKey in this.filters) {
                    var filterFunc = this.filters[propKey];
                    var propValue = event[propKey];
                    if (propValue && !filterFunc(propValue)) {
                        event[cacheKey] = true;
                        return true;
                    }
                }
                event[cacheKey] = false;
                return false;
            }
        },
        computed: {
            tableData: function() {
                var count = 0;
                var filtered = [];
                var cacheKey = this.filters['cacheKey'];
                this.propViewModes[cacheKey] = 'hidden';
                for (var i in this.events) {
                    var event = this.events[i];
                    if (this.isFiltered(event, cacheKey)) {
                        continue;
                    }
                    filtered.push(event);
                    count++;
                    if (count === 100) {
                        break;
                    }
                }
                return filtered;
            },
        },
        created: function() {
            var me = this;
            (function(){
                axios.get('/more-events?ts=' + Date.now())
                    .then(function (resp) {
                        for (var i in resp.data) {
                            var event = resp.data[i];
                            for (var propKey in event) {
                                if (propKey === 'level' || propKey === 'timestamp' || propKey === 'lineNumber') {
                                    continue;
                                }
                                var propValue = event[propKey];
                                if (!(propKey in me.propValues)) {
                                    Vue.set(me.propValues, propKey, []);
                                } else {
                                    var vals = me.propValues[propKey];
                                    if (vals.length < 100 && vals.indexOf(propValue) === -1) {
                                        vals.push(propValue);
                                    }
                                }
                            }
                        }
                        me.events = resp.data.reverse().concat(me.events);
                    });
                setTimeout(arguments.callee, 1000);
            })();
        }
    })
</script>